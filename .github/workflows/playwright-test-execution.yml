name: Test Execution - Playwright
run-name: ${{inputs.env}} - playwright test execution

on:
  workflow_dispatch:
    inputs:
      env:
        description: Select Test Environment
        type: choice
        default: staging
        options:
          - staging
          - prod

env:
  TESTENV: ${{inputs.env}}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout Test Repo
      uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Checkout RoleVault Webapp Repo
      uses: actions/checkout@v4
      with:
        repository: NayeemJohnY/rolevault-webapp
        path: rolevault-webapp

    - name: Start RoleVault Webapp (Docker Compose Up)
      run: docker compose -f rolevault-webapp/docker-compose.${{env.TESTENV}}.yml up -d

    - name: Tail logs until RoleVault started or timeout
      shell: bash
      run: |
        timeout 300s bash -c '
        docker compose -f rolevault-webapp/docker-compose.${{ env.TESTENV }}.yml logs -f | while IFS= read -r line
        do
          echo "$line"
          if echo "$line" | grep -q "✅ RoleVault started successfully!"; then
            echo "RoleVault started successfully message found, stopping log stream."
            exit 0
          fi
        done
        echo "❌ Timeout reached: RoleVault did not start successfully within 5 minutes."
        exit 1
        '

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      run: npx playwright test
    
    - name: Stop RoleVault Webapp (Docker Compose Down)
      if: always()
      run: docker compose -f rolevault-webapp/docker-compose.${{env.TESTENV}}.yml down
  
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
